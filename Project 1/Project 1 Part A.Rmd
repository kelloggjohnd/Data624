---
title: "Data 624 - Project 1"
author: "John Kellogg"
date: "3/22/2021"
output: 
 html_document:
  code_folding: hide
  toc: true
  toc_float: 
    collapsed: true
    smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fpp2)
library(readxl)
library(knitr)
library(urca)
library(lubridate)
library(tidyverse)
library(grid)
library(gridExtra)
```

## Part A
### Assignment Question
In part A, I want you to forecast how much cash is taken out of 4 different ATM machines for May 2010.  The data is given in a single file.  The variable ‘Cash’ is provided in hundreds of dollars, other than that it is straight forward.   I am being somewhat ambiguous on purpose to make this have a little more business feeling.  Explain and demonstrate your process, techniques used and not used, and your actual forecast.  I am giving you data via an excel file, please provide your written report on your findings, visuals, discussion and your R code via an RPubs link along with the actual.rmd file.  Also, please submit the forecast which you will put in an Excel readable file.


### Data Management
```{r atm_data, warning=FALSE}
data_raw <- read_excel ('./data/ATM624Data.xlsx', col_names = TRUE,
                        col_types = c('date','text','numeric'))%>%
  rename(date = DATE, atm = ATM, cash = Cash)%>%
  mutate(date = as.Date(date, origin = "1899-12-30")) 

```

```{r}
summary(data_raw)
```
After loading the data, we see there are a number of NA's which need to be dealt with.  Generally, dropping the cases is not advisable as the time series should have all the dates.  In this case I have adjust that logic as not only the amount of cash is missing but also which ATM the cash is in is missing. Since I can not imply the location it does not make sense to do math manipulation for missing 'cash' values. 
  
I will perform the following process:

* I will drop any incomplete case on the 'ATM' row. 
  * The N/A's in the 'ATM' column are at the end and look like they are at the start of the month.  
  * It should leave me with data from 2009-05-01 to 2010-04-30.
* Any remaining NA's in the 'CASH' column will have a k-nearest neighbor moving average applied.
  * The data is in hundreds of dollars and does not have any decimal points, any decimals generated by this process will be rounded to zero.
  
```{r}
atm <- data_raw
atm <- data_raw[complete.cases(data_raw),]
atm$cash <- imputeTS::na_ma(atm$cash, k=5, weighting = "simple")

# as the data is in hundreds of dollars &
atm <- atm %>%
  mutate(across(where(is.numeric), round, 0))
```

```{r}
atm <- atm%>%
  spread(atm, cash)

atm_ts <- ts(atm %>% select(-date))
#str(atm_ts)
```

```{r}
autoplot(atm_ts)+
  labs(title = "Cash per all ATMs", subtitle = "By week")+
  scale_y_continuous("Withdrawn in Hundreds")
```

* Huge outlier in ATM4 will need processing.
* No further outliers are present.
  
#### ATM 1
```{r}
atm1 <- atm_ts[,1]
atm1<-ts(atm1, frequency = 7)
ggtsdisplay(atm1, points = FALSE, plot.type = "histogram")
```

* Seasonality in the data
* Huge lag spikes, will need to understand better after the Box-Cox transform

#### ATM 2
```{r}
atm2 <- atm_ts[,2]
atm2<-ts(atm2, frequency = 7)
ggtsdisplay(atm2, points = FALSE, plot.type = "histogram")
```

* Seasonality in the data
* Huge lag spikes, will need to understand better after the Box-Cox transform

#### ATM 3  
```{r}
atm3 <- atm_ts[,3]
atm3[which(atm3 == 0)]<-NA
atm3<-ts(atm3, frequency = 7)
ggtsdisplay(atm3, points = FALSE, plot.type = "histogram")
```
  
* Only 3 observations in the data
  * Not sure if there is enough data to accurately predict the needed amount of cash.
* May need to use median for prediction
  
#### ATM 4
```{r}
atm4 <- atm_ts[,4]
atm4[which.max(atm4)]<-median(atm4, na.rm = TRUE)
atm4<-ts(atm4, frequency = 7)
ggtsdisplay(atm4, points = FALSE, plot.type = "histogram")
```

* With the outlier brought back down using median the data is in a good stage to move forward
* Not sure if we are seeing seasonality 

### Creating Forecast models  
  
All Models will start with a Box-Cox transform as it is the simplest transform method. Each will be evaluated to see if the transform is beneficial, gets removed, or if other steps are required.
  
#### ATM1
  
```{r}
atm1_lambda <- BoxCox.lambda(atm1)
ggtsdisplay(atm1  %>% BoxCox(atm1_lambda))
ur.kpss(atm1  %>% BoxCox(atm1_lambda)) %>% summary
```

* We still see regular lag spikes at 7, 14, and 21

```{r}
ggtsdisplay(diff(atm1, 7), points = FALSE)
ur.kpss(diff(atm1, 7)) %>% summary
```
  
* Setting the differential at 7 to account for the regular spikes seems to do the trick and reduce the test statistic

```{r}
ggtsdisplay(atm1  %>% BoxCox(atm1_lambda)%>% diff(7))
ur.kpss(atm1  %>% BoxCox(atm1_lambda) %>% diff(7)) %>% summary
```

* Success with a Box-Cox and Diff of 7
* This leads to an Arima model of 2,0,2 with seasonally of 0,1,1

```{r}
atm_model1 <- Arima(atm1, order=c(2,0,2), seasonal = c(0,1,1), lambda = atm1_lambda)
summary(atm_model1)
checkresiduals(atm_model1)
```

```{r}
atm1_check <- auto.arima(atm1, approximation = FALSE, lambda = atm1_lambda)
summary(atm1_check)
checkresiduals(atm1_check)
```

* The Auto Arima model came up with a (0,0,2)(0,1,1)[7]
* I chose (2,0,2)(0,1,1)[7]
* According to the residuals, both models represent the data well as the residuals are not distinguishable from white noise.
* The AICc is lower for the auto model and the P-Value is lower for the manual
* I will keep the manual model 

#### ATM2

No Transforms
```{r}
ggtsdisplay(atm2, points = FALSE, plot.type = "histogram")
ur.kpss(atm2) %>% summary
```

Box-Cox Transform
```{r}
atm2_lambda <- BoxCox.lambda(atm2)

ggtsdisplay(atm2  %>% BoxCox(atm2_lambda))
ur.kpss(atm2 %>% BoxCox(atm2_lambda)) %>% summary
```

* The Box-Cox transform did not change the data much
  * Perhaps I should start with a general diff()

```{r}
ndiffs(atm2)
```

```{r}
ggtsdisplay(diff(atm2, 7), points = FALSE)
ur.kpss(diff(atm2, 7)) %>% summary
```

* The Lag Spike at 7 and the differential check returning 1 I'll start my model with a (2,1,2)(0,1,1)

```{r}
atm_model2<- Arima(atm2, order=c(2,1,2), seasonal = c(0,1,1), lambda = atm2_lambda)
summary(atm_model2)
checkresiduals(atm_model2)
```

```{r}
atm2_check <- auto.arima(atm2, approximation = FALSE, lambda = atm2_lambda)
summary(atm2_check)
checkresiduals(atm2_check)
```

* The Auto Arima model came up with a (2,0,2)(0,1,1)[7]
* I chose (2,1,2)(0,1,1)[7]
* My model has MUCH lower AIC and AICc; slightly larger but not significant P value.
* I will still stay with my model

#### ATM3

I had a hard time figuring out what to do with this model.  There is only 3 observations in the dataset.  After doing research, I chose a random walk model vs an average model using the non-zero observations.  
```{r}
#atm3_lambda <- BoxCox.lambda(atm3) # lambda for ATM3 will not be required

atm_model3 <- rwf(atm3, h=31)
```


#### ATM4

```{r}
atm4_lambda <- BoxCox.lambda(atm4)

ggtsdisplay(atm4, points = FALSE, plot.type = "histogram")
```

```{r}
ndiffs(atm4)
```

```{r}
ggtsdisplay(atm4  %>% diff(7))
```

* The data seems different than ATM 1&2.  
  * Not sure if we need to go as extreme on this one.
  * The plot seems to be already at the white noise level
  * I will try (1,0,0)(0,1,0)

```{r}
atm_model4 <- Arima(atm4, order=c(1,0,0), seasonal = c(0,1,0), lambda = atm4_lambda)
summary(atm_model4)
checkresiduals(atm_model4)
```

```{r}
atm4_check <- auto.arima(atm4, approximation = FALSE, lambda = atm4_lambda)
summary(atm4_check)
checkresiduals(atm4_check)
```

* I will go with the Auto model for this one. The AIC and AICc are lower.
  * Additionally the P-value from mine is significant
  * The Mean Error is negative, the RMSE is higher
```{r}
# imputing the Auto Arima into the list
atm_model5 <- Arima(atm4, order=c(1,0,0), seasonal = c(2,0,0), lambda = atm4_lambda)
```

### Forecasting

```{r}
atm1_forecast <- forecast(atm_model1, 31, level = 95)
autoplot(atm1_forecast) + 
    labs(title = "ATM1: ARIMA(2,0,2)(0,1,1)", x = "Week", y = NULL) +
    theme(legend.position = "none")
```

```{r}
atm2_forecast <- forecast(atm_model2, 31, level = 95)
autoplot(atm2_forecast) + 
    labs(title = "ATM2: ARIMA(2,1,2)(0,1,1)", x = "Week", y = NULL) +
    theme(legend.position = "none")
```


```{r}
autoplot(atm_model3) + 
    labs(title = "ATM3: Random Walk", x = "Week", y = NULL) +
    theme(legend.position = "none")

atm3_forecast <- forecast(atm_model3)
```


```{r}
atm4_forecast <- forecast(atm_model5, 31, level = 95)
autoplot(atm2_forecast) + 
    labs(title = "ATM4: ARIMA(1,0,0)(2,0,0)", x = "Week", y = NULL) +
    theme(legend.position = "none")
```

```{r}
export <- rbind(atm1_forecast$mean, atm2_forecast$mean, atm3_forecast$mean, atm4_forecast$mean)
write.csv(export, "ATM Forecasts.csv")
```


